name: Build Multi-Brand Websites

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
    - uses: actions/checkout@v3

    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        version: latest

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.0'

    - name: Setup R packages
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        extra-packages: any::rmarkdown, any::yaml

    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod a+x /usr/local/bin/yq

    - name: Create Directory Structure
      run: |
        mkdir -p _site

    - name: Generate Brand Websites
      run: |
        # Get list of all brand directories
        brand_dirs=$(find . -type f -name "_brand.yml" -exec dirname {} \; | sed 's|^./||')

        # Function to modify _quarto.yml for each brand
        process_brand() {
          local brand_dir=$1
          local brand_name=$(basename "$brand_dir")
          echo "Processing ${brand_name}..."
          
          # Create a temporary copy of base _quarto.yml
          cp _quarto.yml _quarto_temp.yml
          
          # Update the brand and output directory in the temporary file
          yq -i '.brand = "'"${brand_dir}/_brand.yml"'"' _quarto_temp.yml
          yq -i '.project."output-dir" = "_site/'"${brand_name}"'"' _quarto_temp.yml
          
          # Copy demo-index.qmd to index.qmd in temp directory
          mkdir -p temp_source
          cp demo-index.qmd temp_source/index.qmd
          
          # Render using the temporary config
          quarto render --execute-dir=temp_source _quarto_temp.yml
          
          # Clean up
          rm _quarto_temp.yml
          rm -rf temp_source
        }

        # Process each brand directory
        for brand_dir in $brand_dirs; do
          process_brand "$brand_dir"
        done

    - name: Generate Gallery Index
      run: |
        # Render the main index page using gallery-specific _quarto.yml
        quarto render index.qmd --config gallery_quarto.yml
    
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v1
      with:
        path: "_site"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
